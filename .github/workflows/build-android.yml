name: Build Android APK

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install Gradle 8.13
        run: |
          wget -q https://services.gradle.org/distributions/gradle-8.13-bin.zip
          sudo unzip -q -d /opt/gradle gradle-8.13-bin.zip
          echo "/opt/gradle/gradle-8.13/bin" >> $GITHUB_PATH

      - name: Create AndroidX configuration FORCEFULLY
        run: |
          # Crear gradle.properties en múltiples ubicaciones para asegurar
          echo "=== Creating gradle.properties with AndroidX ==="
          
          # 1. En la raíz del proyecto (principal)
          cat > gradle.properties << 'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          android.defaults.buildfeatures.buildconfig=true
          android.defaults.buildfeatures.renderscript=true
          android.defaults.buildfeatures.resvalues=true
          android.defaults.buildfeatures.shaders=true
          EOF
          
          # 2. También en carpeta gradle/
          mkdir -p gradle
          cp gradle.properties gradle/
          
          # 3. Y en el home del usuario para Gradle
          mkdir -p ~/.gradle
          cp gradle.properties ~/.gradle/
          
          echo "=== Verifying files ==="
          echo "Project root:"
          ls -la gradle.properties
          echo "Gradle folder:"
          ls -la gradle/gradle.properties
          echo "Home folder:"
          ls -la ~/.gradle/gradle.properties
          
          echo "=== Content ==="
          cat gradle.properties

      - name: Build with forced AndroidX
        run: |
          echo "=== Building with AndroidX enabled ==="
          gradle clean assembleDebug --no-daemon --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: buscaminas-apk
          path: app/build/outputs/apk/debug/
          retention-days: 7