name: Build Android APK

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install Gradle 8.13 manually
        run: |
          wget -q https://services.gradle.org/distributions/gradle-8.13-bin.zip
          sudo unzip -q -d /opt/gradle gradle-8.13-bin.zip
          echo "/opt/gradle/gradle-8.13/bin" >> $GITHUB_PATH

      - name: Force AndroidX configuration
        run: |
          # Crear gradle.properties con AndroidX forzado
          cat > gradle.properties << EOF
          # AndroidX Configuration
          android.useAndroidX=true
          android.enableJetifier=true
          
          # Gradle Configuration
          org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.daemon=false
          
          # Kotlin Configuration
          kotlin.code.style=official
          EOF
          
          echo "=== gradle.properties content ==="
          cat gradle.properties

      - name: Build with forced AndroidX
        run: |
          echo "=== Building with AndroidX enabled ==="
          gradle --version
          gradle clean assembleDebug --no-daemon --stacktrace

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: buscaminas-apk
          path: app/build/outputs/apk/debug/
          retention-days: 7